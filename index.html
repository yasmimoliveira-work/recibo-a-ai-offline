<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Recibo Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

<h2>Recibo Digital</h2>
<label>Número do Recibo</label><br>
<input type="text" id="numeroRecibo" readonly><br><br>


<label>Data</label><br>
<input type="date" id="data"><br><br>

<label>Número do Lote</label><br>
<input type="text" id="lote"><br><br>

<label>Aldeia</label><br>
<input type="text" id="aldeia"><br><br>

<label>Região</label><br>
<input type="text" id="regiao"><br><br>

<label>Responsável pela Entrega</label><br>
<input type="text" id="responsavel"><br><br>

<label>Produtor</label><br>
<input type="text" id="produtor"><br><br>

<label>Quantidade (Sacas)</label><br>
<input type="number" id="quantidade"><br><br>

<label>Valor Recebido</label><br>
<input type="number" id="valor"><br><br>

<!-- ASSINATURA SIMPLIFICADA (ANDROID FRIENDLY) -->
<label>Nome de quem recebeu</label><br>
<input type="text" id="assinatura_nome"><br><br>

<label>
  <input type="checkbox" id="confirmacao">
  Confirmo o recebimento das informações acima
</label>
<br><br>

<button onclick="salvar()">Salvar Recibo (offline)</button>
<br><br>
<button onclick="sincronizar()">Sincronizar agora</button>

<p id="status"></p>

<script>
  const API_URL = "https://script.googleusercontent.com/a/macros/institutoiepe.org.br/echo?user_content_key=AehSKLjhc6ggCnp-JoB6h_oByTYBD96YBfrQe9DF-xwJtvxeG8kov_DneaPGh_ux8L1k4iCrwJJfKfPOIZdb_bdLjTe-M2BNd3oRHN2byvF8JKazP9CkuxShHcybvOAAyG89RPyL_3A5a8BctA4bt3WrHjNbg92nXTATHvMANPHiU9cvcKKbExuAqxml1A_6cKhshWWc2LF4ScrLKoyVmT3GYQp9M34EzHYinZwvbFFbkiHjWYSKBaqisjvk0-kVQ1iFq9xbdQ19mDSlNYzmt3UXCt5lgaAohOdrvLAYLc6Ir93kQhKKxtrUjwSJbWdqjw&lib=Mwpl13yBil3ay0bmPcM0_zUw9ezPKz0cG";

  function gerarNumeroRecibo() {
    let ultimo = localStorage.getItem("ultimoNumeroRecibo");
    let proximo = ultimo ? parseInt(ultimo) + 1 : 1;
    localStorage.setItem("ultimoNumeroRecibo", proximo);
    return String(proximo).padStart(4, "0");
  }

  window.onload = function () {
    document.getElementById("numeroRecibo").value = gerarNumeroRecibo();
  };

  function salvar() {
    const nome = document.getElementById("assinatura_nome").value;
    const confirmou = document.getElementById("confirmacao").checked;

    if (!nome || !confirmou) {
      alert("Informe o nome e confirme o recebimento.");
      return;
    }

    const recibo = {
      numeroRecibo: document.getElementById("numeroRecibo").value,
      data: document.getElementById("data").value,
      numeroLote: document.getElementById("lote").value,
      aldeia: document.getElementById("aldeia").value,
      regiao: document.getElementById("regiao").value,
      responsavelEntrega: document.getElementById("responsavel").value,
      produtor: document.getElementById("produtor").value,
      quantidade: document.getElementById("quantidade").value,
      valorRecebido: document.getElementById("valor").value,
      assinatura: nome,
      status: "PENDENTE",
      criadoEm: new Date().toISOString()
    };

    const lista = JSON.parse(localStorage.getItem("recibos")) || [];
    lista.push(recibo);
    localStorage.setItem("recibos", JSON.stringify(lista));

    document.getElementById("status").innerText =
      "Recibo salvo no celular (offline)";
  }

  async function sincronizar() {
    if (!navigator.onLine) {
      document.getElementById("status").innerText = "Sem internet";
      return;
    }

    let lista = JSON.parse(localStorage.getItem("recibos")) || [];
    let enviados = 0;

    for (let r of lista) {
      if (r.status === "PENDENTE") {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(r)
        });
        const json = await res.json();
        if (json.status === "ok") {
          r.status = "SINCRONIZADO";
          enviados++;
        }
      }
    }

    localStorage.setItem("recibos", JSON.stringify(lista));
    document.getElementById("status").innerText =
      enviados ? "Sincronização concluída" : "Nada para sincronizar";
  }
</script>
</body>
</html>
