<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Recibo Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

</head>

<body>

<h2>Recibo Digital</h2>

<label>Número do Recibo</label><br>
<input type="text" id="numeroRecibo" readonly><br><br>

<label>Data</label><br>
<input type="date" id="data"><br><br>

<label>Número do Lote</label><br>
<input type="text" id="lote"><br><br>

<label>Aldeia</label><br>
<input type="text" id="aldeia"><br><br>

<label>Região</label><br>
<input type="text" id="regiao"><br><br>

<label>Responsável pela Entrega</label><br>
<input type="text" id="responsavel"><br><br>

<label>Produtor</label><br>
<input type="text" id="produtor"><br><br>

<label>Quantidade (Sacas)</label><br>
<input type="number" id="quantidade"><br><br>

<label>Valor Recebido</label><br>
<input type="number" id="valor"><br><br>

<label>Assinatura (no dedo)</label><br>
<canvas id="assinaturaCanvas"
        width="300"
        height="150"
        style="border:1px solid #000; touch-action:none;">
</canvas><br>
<button type="button" onclick="limparAssinatura()">Limpar assinatura</button>
<br><br>

<label>QR Code do Recibo</label><br>
<div id="qrcode"></div>
<br><br>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>


<label>Nome de quem recebeu</label><br>
<input type="text" id="assinatura_nome"><br><br>

<label>
  <input type="checkbox" id="confirmacao">
  Confirmo o recebimento das informações acima
</label>
<br><br>

<button onclick="salvar()">Salvar Recibo (offline)</button>
<br><br>
<button onclick="sincronizar()">Sincronizar agora</button>

<p id="status"></p>

<script>
const API_URL = "https://script.googleusercontent.com/a/macros/institutoiepe.org.br/echo?user_content_key=AehSKLjhc6ggCnp-JoB6h_oByTYBD96YBfrQe9DF-xwJtvxeG8kov_DneaPGh_ux8L1k4iCrwJJfKfPOIZdb_bdLjTe-M2BNd3oRHN2byvF8JKazP9CkuxShHcybvOAAyG89RPyL_3A5a8BctA4bt3WrHjNbg92nXTATHvMANPHiU9cvcKKbExuAqxml1A_6cKhshWWc2LF4ScrLKoyVmT3GYQp9M34EzHYinZwvbFFbkiHjWYSKBaqisjvk0-kVQ1iFq9xbdQ19mDSlNYzmt3UXCt5lgaAohOdrvLAYLc6Ir93kQhKKxtrUjwSJbWdqjw&lib=Mwpl13yBil3ay0bmPcM0_zUw9ezPKz0cG";

/* ========= NUMERO DO RECIBO ========= */
function gerarNumeroRecibo() {
  let ultimo = localStorage.getItem("ultimoNumeroRecibo");
  let proximo = ultimo ? parseInt(ultimo) + 1 : 1;
  localStorage.setItem("ultimoNumeroRecibo", proximo);
  return String(proximo).padStart(4, "0");
}

/* ========= ASSINATURA ========= */
let canvas, ctx, desenhando = false;

window.addEventListener("load", () => {
  numeroRecibo.value = gerarNumeroRecibo();

  canvas = document.getElementById("assinaturaCanvas");
  ctx = canvas.getContext("2d");
  ctx.lineWidth = 2;
  ctx.lineCap = "round";

  canvas.addEventListener("touchstart", iniciar);
  canvas.addEventListener("touchmove", desenhar);
  canvas.addEventListener("touchend", parar);

  canvas.addEventListener("mousedown", iniciar);
  canvas.addEventListener("mousemove", desenhar);
  canvas.addEventListener("mouseup", parar);
});

function iniciar(e) {
  desenhando = true;
  ctx.beginPath();
  const p = ponto(e);
  ctx.moveTo(p.x, p.y);
}

function desenhar(e) {
  if (!desenhando) return;
  e.preventDefault();
  const p = ponto(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
}

function parar() {
  desenhando = false;
}

function ponto(e) {
  const rect = canvas.getBoundingClientRect();
  const t = e.touches ? e.touches[0] : e;
  return { x: t.clientX - rect.left, y: t.clientY - rect.top };
}

function limparAssinatura() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

/* ========= SALVAR RECIBO ========= */
function salvar() {
  if (!confirmacao.checked || !assinatura_nome.value) {
    alert("Informe o nome e confirme o recebimento.");
    return;
  }

  const recibo = {
    numeroRecibo: numeroRecibo.value,
    data: data.value,
    lote: lote.value,
    aldeia: aldeia.value,
    regiao: regiao.value,
    responsavel: responsavel.value,
    produtor: produtor.value,
    quantidade: quantidade.value,
    valor: valor.value,
    assinaturaNome: assinatura_nome.value,
    assinaturaImagem: canvas.toDataURL(),
    status: "PENDENTE",
    criadoEm: new Date().toISOString()
  };

  const lista = JSON.parse(localStorage.getItem("recibos")) || [];
  lista.push(recibo);
  localStorage.setItem("recibos", JSON.stringify(lista));

  status.innerText = "Recibo salvo offline";

  /* ========= QR CODE ========= */
  qrcode.innerHTML = "";
  const textoQR =
    "Recibo Nº: " + recibo.numeroRecibo + "\n" +
    "Data: " + recibo.data + "\n" +
    "Produtor: " + recibo.produtor + "\n" +
    "Valor: " + recibo.valor;

  new QRCode(qrcode, {
    text: textoQR,
    width: 150,
    height: 150
  });
}

/* ========= SINCRONIZAR ========= */
async function sincronizar() {
  if (!navigator.onLine) {
    status.innerText = "Sem internet";
    return;
  }

  let lista = JSON.parse(localStorage.getItem("recibos")) || [];
  let enviados = 0;

  for (let r of lista) {
    if (r.status === "PENDENTE") {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(r)
      });
      const j = await res.json();
      if (j.status === "ok") {
        r.status = "SINCRONIZADO";
        enviados++;
      }
    }
  }

  localStorage.setItem("recibos", JSON.stringify(lista));
  status.innerText = enviados ? "Sincronização concluída" : "Nada para sincronizar";
}
</script>


</body>
</html>

