<script>
  const API_URL = "https://script.googleusercontent.com/a/macros/institutoiepe.org.br/echo?user_content_key=AehSKLjhc6ggCnp-JoB6h_oByTYBD96YBfrQe9DF-xwJtvxeG8kov_DneaPGh_ux8L1k4iCrwJJfKfPOIZdb_bdLjTe-M2BNd3oRHN2byvF8JKazP9CkuxShHcybvOAAyG89RPyL_3A5a8BctA4bt3WrHjNbg92nXTATHvMANPHiU9cvcKKbExuAqxml1A_6cKhshWWc2LF4ScrLKoyVmT3GYQp9M34EzHYinZwvbFFbkiHjWYSKBaqisjvk0-kVQ1iFq9xbdQ19mDSlNYzmt3UXCt5lgaAohOdrvLAYLc6Ir93kQhKKxtrUjwSJbWdqjw&lib=Mwpl13yBil3ay0bmPcM0_zUw9ezPKz0cG";

  let canvas, ctx;
  let desenhando = false;

  // GARANTE QUE O HTML JÁ CARREGOU (ANDROID FIX)
  window.onload = () => {
    canvas = document.getElementById("assinatura");
    ctx = canvas.getContext("2d");

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";

    canvas.addEventListener("touchstart", e => {
      e.preventDefault();
      desenhando = true;
      const t = e.touches[0];
      ctx.beginPath();
      ctx.moveTo(
        t.clientX - canvas.getBoundingClientRect().left,
        t.clientY - canvas.getBoundingClientRect().top
      );
    });

    canvas.addEventListener("touchmove", e => {
      e.preventDefault();
      if (!desenhando) return;
      const t = e.touches[0];
      ctx.lineTo(
        t.clientX - canvas.getBoundingClientRect().left,
        t.clientY - canvas.getBoundingClientRect().top
      );
      ctx.stroke();
    });

    canvas.addEventListener("touchend", () => {
      desenhando = false;
    });
  };

  function limparAssinatura() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function salvar() {
    let recibo = {
      data: document.getElementById("data").value,
      numeroLote: document.getElementById("lote").value,
      aldeia: document.getElementById("aldeia").value,
      regiao: document.getElementById("regiao").value,
      responsavelEntrega: document.getElementById("responsavel").value,
      produtor: document.getElementById("produtor").value,
      quantidade: document.getElementById("quantidade").value,
      valorRecebido: document.getElementById("valor").value,
      assinatura: canvas.toDataURL("image/png"),
      status: "PENDENTE"
    };

    let lista = JSON.parse(localStorage.getItem("recibos")) || [];
    lista.push(recibo);
    localStorage.setItem("recibos", JSON.stringify(lista));

    document.getElementById("status").innerText =
      "Recibo salvo no celular (offline)";
  }

  async function sincronizar() {
    if (!navigator.onLine) {
      document.getElementById("status").innerText = "Sem internet";
      return;
    }

    let lista = JSON.parse(localStorage.getItem("recibos")) || [];
    let sincronizou = false;

    for (let r of lista) {
      if (r.status === "PENDENTE") {
        try {
          let res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(r),
            headers: { "Content-Type": "application/json" }
          });

          let ret = await res.json();
          if (ret.status === "ok") {
            r.status = "SINCRONIZADO";
            sincronizou = true;
          }
        } catch (e) {}
      }
    }

    localStorage.setItem("recibos", JSON.stringify(lista));
    document.getElementById("status").innerText = sincronizou
      ? "Sincronização concluída"
      : "Nada para sincronizar";
  }
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>
