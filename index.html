<script>
  // URL DA API (GOOGLE APPS SCRIPT)
  const API_URL = "https://script.googleusercontent.com/a/macros/institutoiepe.org.br/echo?user_content_key=AehSKLjhc6ggCnp-JoB6h_oByTYBD96YBfrQe9DF-xwJtvxeG8kov_DneaPGh_ux8L1k4iCrwJJfKfPOIZdb_bdLjTe-M2BNd3oRHN2byvF8JKazP9CkuxShHcybvOAAyG89RPyL_3A5a8BctA4bt3WrHjNbg92nXTATHvMANPHiU9cvcKKbExuAqxml1A_6cKhshWWc2LF4ScrLKoyVmT3GYQp9M34EzHYinZwvbFFbkiHjWYSKBaqisjvk0-kVQ1iFq9xbdQ19mDSlNYzmt3UXCt5lgaAohOdrvLAYLc6Ir93kQhKKxtrUjwSJbWdqjw&lib=Mwpl13yBil3ay0bmPcM0_zUw9ezPKz0cG";

  // SALVAR RECIBO (OFFLINE)
  function salvar() {
    const nomeAssinatura = document.getElementById("assinatura_nome").value;
    const confirmou = document.getElementById("confirmacao").checked;

    if (!nomeAssinatura || !confirmou) {
      alert("Informe o nome e confirme o recebimento.");
      return;
    }

    const recibo = {
      data: document.getElementById("data").value,
      numeroLote: document.getElementById("lote").value,
      aldeia: document.getElementById("aldeia").value,
      regiao: document.getElementById("regiao").value,
      responsavelEntrega: document.getElementById("responsavel").value,
      produtor: document.getElementById("produtor").value,
      quantidade: document.getElementById("quantidade").value,
      valorRecebido: document.getElementById("valor").value,
      assinatura: nomeAssinatura,
      confirmacao: "CONFIRMADO",
      status: "PENDENTE",
      dataCriacao: new Date().toISOString()
    };

    const lista = JSON.parse(localStorage.getItem("recibos")) || [];
    lista.push(recibo);
    localStorage.setItem("recibos", JSON.stringify(lista));

    document.getElementById("status").innerText =
      "Recibo salvo no celular (offline)";
  }

  // SINCRONIZAR COM A PLANILHA
  async function sincronizar() {
    if (!navigator.onLine) {
      document.getElementById("status").innerText = "Sem internet";
      return;
    }

    let lista = JSON.parse(localStorage.getItem("recibos")) || [];
    let sincronizou = false;

    for (let i = 0; i < lista.length; i++) {
      if (lista[i].status === "PENDENTE") {
        try {
          const resposta = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(lista[i])
          });

          const retorno = await resposta.json();

          if (retorno.status === "ok") {
            lista[i].status = "SINCRONIZADO";
            lista[i].dataSincronizacao = new Date().toISOString();
            sincronizou = true;
          }
        } catch (erro) {
          console.error("Erro ao sincronizar", erro);
        }
      }
    }

    localStorage.setItem("recibos", JSON.stringify(lista));

    document.getElementById("status").innerText = sincronizou
      ? "Sincronização concluída"
      : "Nada para sincronizar";
  }
</script>

<script>
  // REGISTRO DO SERVICE WORKER
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>
