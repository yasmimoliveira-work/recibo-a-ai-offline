<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Recibo Digital Offline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="manifest" href="manifest.json">
</head>

<body>

  <h2>Recibo Digital</h2>

  <label>Data</label><br>
  <input type="date" id="data"><br><br>

  <label>Número do Lote</label><br>
  <input type="text" id="lote"><br><br>

  <label>Aldeia</label><br>
  <input type="text" id="aldeia"><br><br>

  <label>Região</label><br>
  <input type="text" id="regiao"><br><br>

  <label>Responsável pela Entrega</label><br>
  <input type="text" id="responsavel"><br><br>

  <label>Produtor</label><br>
  <input type="text" id="produtor"><br><br>

  <label>Quantidade (Sacas)</label><br>
  <input type="number" id="quantidade"><br><br>

  <label>Valor Recebido</label><br>
  <input type="number" id="valor"><br><br>

  <label>Assinatura</label><br>
  <canvas id="assinatura" width="300" height="150" style="border:1px solid #000;"></canvas><br>
  <button onclick="limparAssinatura()">Limpar assinatura</button>
  <br><br>

  <button onclick="salvar()">Salvar Recibo (offline)</button>
  <br><br>
  <button onclick="sincronizar()">Sincronizar agora</button>

  <p id="status"></p>

  <script>
    const API_URL = "https://script.googleusercontent.com/a/macros/institutoiepe.org.br/echo?user_content_key=AehSKLjhc6ggCnp-JoB6h_oByTYBD96YBfrQe9DF-xwJtvxeG8kov_DneaPGh_ux8L1k4iCrwJJfKfPOIZdb_bdLjTe-M2BNd3oRHN2byvF8JKazP9CkuxShHcybvOAAyG89RPyL_3A5a8BctA4bt3WrHjNbg92nXTATHvMANPHiU9cvcKKbExuAqxml1A_6cKhshWWc2LF4ScrLKoyVmT3GYQp9M34EzHYinZwvbFFbkiHjWYSKBaqisjvk0-kVQ1iFq9xbdQ19mDSlNYzmt3UXCt5lgaAohOdrvLAYLc6Ir93kQhKKxtrUjwSJbWdqjw&lib=Mwpl13yBil3ay0bmPcM0_zUw9ezPKz0cG";

    function salvar() {
      const canvas = document.getElementById("assinatura");

      let recibo = {
        data: document.getElementById("data").value,
        numeroLote: document.getElementById("lote").value,
        aldeia: document.getElementById("aldeia").value,
        regiao: document.getElementById("regiao").value,
        responsavelEntrega: document.getElementById("responsavel").value,
        produtor: document.getElementById("produtor").value,
        quantidade: document.getElementById("quantidade").value,
        valorRecebido: document.getElementById("valor").value,
        assinatura: canvas.toDataURL(),
        status: "PENDENTE"
      };

      let lista = JSON.parse(localStorage.getItem("recibos")) || [];
      lista.push(recibo);
      localStorage.setItem("recibos", JSON.stringify(lista));

      document.getElementById("status").innerText = "Recibo salvo (offline)";
    }

    async function sincronizar() {
      if (!navigator.onLine) {
        document.getElementById("status").innerText = "Sem internet";
        return;
      }

      let lista = JSON.parse(localStorage.getItem("recibos")) || [];
      let enviado = false;

      for (let recibo of lista) {
        if (recibo.status === "PENDENTE") {
          try {
            let resposta = await fetch(API_URL, {
              method: "POST",
              body: JSON.stringify(recibo),
              headers: { "Content-Type": "application/json" }
            });

            let retorno = await resposta.json();
            if (retorno.status === "ok") {
              recibo.status = "SINCRONIZADO";
              enviado = true;
            }
          } catch (e) {}
        }
      }

      localStorage.setItem("recibos", JSON.stringify(lista));
      document.getElementById("status").innerText =
        enviado ? "Sincronização concluída" : "Nada para sincronizar";
    }

    <script>
  const API_URL = "https://script.googleusercontent.com/a/macros/institutoiepe.org.br/echo?user_content_key=AehSKLjhc6ggCnp-JoB6h_oByTYBD96YBfrQe9DF-xwJtvxeG8kov_DneaPGh_ux8L1k4iCrwJJfKfPOIZdb_bdLjTe-M2BNd3oRHN2byvF8JKazP9CkuxShHcybvOAAyG89RPyL_3A5a8BctA4bt3WrHjNbg92nXTATHvMANPHiU9cvcKKbExuAqxml1A_6cKhshWWc2LF4ScrLKoyVmT3GYQp9M34EzHYinZwvbFFbkiHjWYSKBaqisjvk0-kVQ1iFq9xbdQ19mDSlNYzmt3UXCt5lgaAohOdrvLAYLc6Ir93kQhKKxtrUjwSJbWdqjw&lib=Mwpl13yBil3ay0bmPcM0_zUw9ezPKz0cG";

  let canvas, ctx, desenhando = false;

  window.onload = () => {
    canvas = document.getElementById("assinatura");
    ctx = canvas.getContext("2d");

    canvas.addEventListener("touchstart", e => {
      desenhando = true;
      const t = e.touches[0];
      ctx.beginPath();
      ctx.moveTo(t.clientX - canvas.offsetLeft, t.clientY - canvas.offsetTop);
    });

    canvas.addEventListener("touchmove", e => {
      if (!desenhando) return;
      const t = e.touches[0];
      ctx.lineTo(t.clientX - canvas.offsetLeft, t.clientY - canvas.offsetTop);
      ctx.stroke();
    });

    canvas.addEventListener("touchend", () => desenhando = false);
  };

  function limparAssinatura() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function salvar() {
    let recibo = {
      data: document.getElementById("data").value,
      numeroLote: document.getElementById("lote").value,
      aldeia: document.getElementById("aldeia").value,
      regiao: document.getElementById("regiao").value,
      responsavelEntrega: document.getElementById("responsavel").value,
      produtor: document.getElementById("produtor").value,
      quantidade: document.getElementById("quantidade").value,
      valorRecebido: document.getElementById("valor").value,
      assinatura: canvas.toDataURL(),
      status: "PENDENTE"
    };

    let lista = JSON.parse(localStorage.getItem("recibos")) || [];
    lista.push(recibo);
    localStorage.setItem("recibos", JSON.stringify(lista));

    document.getElementById("status").innerText = "Recibo salvo (offline)";
  }

  async function sincronizar() {
    if (!navigator.onLine) {
      document.getElementById("status").innerText = "Sem internet";
      return;
    }

    let lista = JSON.parse(localStorage.getItem("recibos")) || [];
    for (let r of lista) {
      if (r.status === "PENDENTE") {
        let res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(r),
          headers: { "Content-Type": "application/json" }
        });
        let ret = await res.json();
        if (ret.status === "ok") r.status = "SINCRONIZADO";
      }
    }

    localStorage.setItem("recibos", JSON.stringify(lista));
    document.getElementById("status").innerText = "Sincronização concluída";
  }
</script>

    let desenhando = false;

    canvas.addEventListener("touchstart", e => {
      desenhando = true;
      const t = e.touches[0];
      ctx.beginPath();
      ctx.moveTo(t.clientX - canvas.offsetLeft, t.clientY - canvas.offsetTop);
    });

    canvas.addEventListener("touchmove", e => {
      if (!desenhando) return;
      const t = e.touches[0];
      ctx.lineTo(t.clientX - canvas.offsetLeft, t.clientY - canvas.offsetTop);
      ctx.stroke();
    });

    canvas.addEventListener("touchend", () => desenhando = false);

    function limparAssinatura() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>

</body>
</html>
