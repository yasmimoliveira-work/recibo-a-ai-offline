<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Recibo Digital Uaçei</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- QR CODE (UMA ÚNICA VEZ) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/dist/qrcode.min.js"></script>

  <!-- ESTILO DO APP -->
  <style>
    body {
      font-family: ogonek bold, sans-serif;
      background: #4f6135;
      padding: 16px;
    }

    h2 {
      text-align: center;
      font-size: 22px;
    }

    label {
      font-weight: bold;
      font-size: 15px;
    }

    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 4px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    canvas {
      width: 100%;
      height: 160px;
      border-radius: 8px;
      background: #fff;
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      margin-top: 10px;
      cursor: pointer;
    }

    button:first-of-type {
      background: #2e7d32;
      color: #fff;
    }

    button:last-of-type {
      background: #1565c0;
      color: #fff;
    }

    #qrcode {
      display: flex;
      justify-content: center;
      margin-top: 16px;
    }

    #status {
      margin-top: 12px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>


<body>

<h2>Recibo Digital Uaçei</h2>

<label>Número do Recibo</label><br>
<input type="text" id="numeroRecibo" readonly><br><br>

<label>Data</label><br>
<input type="date" id="data"><br><br>

<label>Número do Lote</label><br>
<input type="text" id="lote"><br><br>

<label>Aldeia</label><br>
<input type="text" id="aldeia"><br><br>

<label>Região</label><br>
<input type="text" id="regiao"><br><br>

<label>Responsável pela Entrega</label><br>
<input type="text" id="responsavel"><br><br>

<label>Produtor</label><br>
<input type="text" id="produtor"><br><br>

<label>Quantidade (Sacas)</label><br>
<input type="number" id="quantidade"><br><br>

<label>Valor Recebido</label><br>
<input type="number" id="valor"><br><br>

<label>Assinatura (no dedo)</label><br>
<canvas
  id="assinaturaCanvas"
  width="300"
  height="150"
  style="border:1px solid #000; touch-action:none;">
</canvas><br>
<button type="button" onclick="limparAssinatura()">Limpar assinatura</button>
<br><br>

<label>QR Code do Recibo</label><br>
<div id="qrcode" style="width:180px;height:180px;"></div>
<br><br>

<label>Nome de quem recebeu</label><br>
<input type="text" id="assinatura_nome"><br><br>

<label>
  <input type="checkbox" id="confirmacao">
  Confirmo o recebimento das informações acima
</label>
<br><br>

<button onclick="salvar()">Salvar Recibo (offline)</button>
<br><br>

<button onclick="sincronizar()">Sincronizar agora</button>

<p id="status"></p>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.googleusercontent.com/a/macros/institutoiepe.org.br/echo";

/* ================= NUMERO RECIBO ================= */
function gerarNumeroRecibo() {
  let ultimo = localStorage.getItem("ultimoNumeroRecibo");
  let proximo = ultimo ? parseInt(ultimo) + 1 : 1;
  localStorage.setItem("ultimoNumeroRecibo", proximo);
  return String(proximo).padStart(4, "0");
}

/* ================= ASSINATURA ================= */
let canvas, ctx, desenhando = false;

window.addEventListener("load", () => {
  numeroRecibo.value = gerarNumeroRecibo();

  canvas = document.getElementById("assinaturaCanvas");
  ctx = canvas.getContext("2d");
  ctx.lineWidth = 2;
  ctx.lineCap = "round";

  canvas.addEventListener("mousedown", iniciar);
  canvas.addEventListener("mousemove", desenhar);
  canvas.addEventListener("mouseup", parar);

  canvas.addEventListener("touchstart", iniciar);
  canvas.addEventListener("touchmove", desenhar);
  canvas.addEventListener("touchend", parar);
});

function iniciar(e) {
  desenhando = true;
  ctx.beginPath();
  const p = ponto(e);
  ctx.moveTo(p.x, p.y);
}

function desenhar(e) {
  if (!desenhando) return;
  e.preventDefault();
  const p = ponto(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
}

function parar() {
  desenhando = false;
}

function ponto(e) {
  const rect = canvas.getBoundingClientRect();
  const t = e.touches ? e.touches[0] : e;
  return {
    x: t.clientX - rect.left,
    y: t.clientY - rect.top
  };
}

function limparAssinatura() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

/* ================= SALVAR RECIBO ================= */
function salvar() {
  if (!confirmacao.checked || !assinatura_nome.value) {
    alert("Informe o nome e confirme o recebimento.");
    return;
  }

  const recibo = {
    numeroRecibo: numeroRecibo.value,
    data: data.value,
    lote: lote.value,
    aldeia: aldeia.value,
    regiao: regiao.value,
    responsavel: responsavel.value,
    produtor: produtor.value,
    quantidade: quantidade.value,
    valor: valor.value,
    assinaturaNome: assinatura_nome.value,
    assinaturaImagem: canvas.toDataURL(),
    status: "PENDENTE",
    criadoEm: new Date().toISOString()
  };

  const lista = JSON.parse(localStorage.getItem("recibos")) || [];
  lista.push(recibo);
  localStorage.setItem("recibos", JSON.stringify(lista));

  status.innerText = "Recibo salvo offline";

  /* ===== GERAR QR CODE ===== */
  const qrContainer = document.getElementById("qrcode");
  qrContainer.innerHTML = "";

  const textoQR =
    "Recibo Nº: " + recibo.numeroRecibo + "\n" +
    "Data: " + recibo.data + "\n" +
    "Produtor: " + recibo.produtor + "\n" +
    "Valor: " + recibo.valor;

  new QRCode(qrContainer, {
    text: textoQR,
    width: 180,
    height: 180,
    correctLevel: QRCode.CorrectLevel.H
  });
}

/* ================= SINCRONIZAR ================= */
async function sincronizar() {
  if (!navigator.onLine) {
    status.innerText = "Sem internet";
    return;
  }

  let lista = JSON.parse(localStorage.getItem("recibos")) || [];
  let enviados = 0;

  for (let r of lista) {
    if (r.status === "PENDENTE") {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(r)
        });
        const j = await res.json();
        if (j.status === "ok") {
          r.status = "SINCRONIZADO";
          enviados++;
        }
      } catch (e) {}
    }
  }

  localStorage.setItem("recibos", JSON.stringify(lista));
  status.innerText = enviados
    ? "Sincronização concluída"
    : "Nada para sincronizar";
}
</script>

</body>
</html>

